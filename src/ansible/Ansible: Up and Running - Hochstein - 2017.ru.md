# Annotation Summary of "Запускаем Ansible (Хоштейн, 2018)" book


## Глава 1. Введение
---

> Разработка системы Ansible началась в феврале 2012-го.

> Ansible, Inc. - компания, стоящая за проектом Ansible, - была приобретена компанией Red Hat.

> Мы внесли множество изменений в это издание, отказaлись от использования контрольных сумм MD5 в OpenSSH и перешли на хэши SHA256.
Все примеры кода в этой книге были протестированы в версии Ansible 2.3.0.

> Откуда взялось название «Ansible»? Название заимствовано из области научной фантастики. Ansible - это устройство связи, способное передавать информацию быстрее скорости света. Писатель Урсула Ле Гуин впервые представила эту идею в своем романе «Планета Роканнона», а остальные писатели-фантасты подхватили ее. Если быть более точным, Майкл ДеХаан позаимствовал название Ansible из книги Орсона Скотта Карда «Игра Эндера». В этой книге Ansible использовался для одновременного контроля большого числа кораблей, удаленных на огромные расстояния.

> Подобно другим средствам управления, Ansible предоставляет предметно-ориентированный язык (Domain Specific Language, DSL), который используется для описания состояний серверов.

> Как мы увидим позже, модули Ansible несут декларативную функцию и используются для описания требуемого состояния серверов.

> Модули также являются идемпотентными.

> То есть сценарии Ansible можно запускать на сервере много раз. Это большое усовершенствование, по сравнению с подходом на основе сценариев командной оболочки.

> Идемпотентность - свойство объекта или операции при повторном применении операции к объекту давать тот же результат, что и при одинарном.

> Идея конвергенции (или сходимости) нередко ассоциируется с именем Марка Бургесса (Mark Burgess) и его системой управления конфигурациями CFEngine.

> Если система управления конфигурациями конвергентна, она может многократно выполнять управляющие воздействия, с каждым разом приводя сервер все ближе к желаемому состоянию. Идея конвергенции неприменима к Ansible из-за отсутствия понятия многоэтапных воздействий на конфигурацию серверов. Модули Ansible устроeны так, что единственный запуск сценария Ansible сразу приводит каждый сервер в желаемое состояние.

> Очень тонкий слой абстракции. Поскольку область применения модуля ограничена и зависит от определенной операционной системы, это позволяет писать качественные и надежно работающие модули. Сценарии Ansible не предназначены для использования в разных контекстах.

> Майкл ДеХаан, создатель программного обеспечения Ansible, является бывшим техническим директором компании Ansible. В октябре 2015-го Red Hat купила Ansible Inc.

> Ansible имеет превосходную поддержку шаблонов и переменных с разными областями видимости.

> Ansible применяет SSН-мультиплексирование для оптимизации производительности. Некоторые специалисты используют Ansible для управления тысячами узлов.

> Ansible использует формат файлов YАМL и язык шаблонов Jinja2.

> При желании Ansible можно установить в локальное виртуальное окружение Python (`virtualenv`). Если вы незнакомы с виртуальными окружениями, можете использовать более новый инструмент под названием `pipsi`.

> Vagrant - отличный инструмент управления виртуальными машинами.

> В Vagrant имеется встроенная возможность подготовки виртуальных машин с Ansible.

> Виртуальная машина в терминологии Vagrant называется `machine`, а ее образ - `bох`.

> Каждому серверу должно быть присвоено имя для идентификации в Ansible.

> playbooks/hosts:
> ```shell
> testserver Ansible_host=127.0.0.1 Ansible_port=2222 \ 
>   Ansible_user=vagrant \ 
>   Ansible_private_key_file=.vagrant/мachines/default/virtualbox/private_key
> ```

> Один из недостатков использования Vagrant: мы вынуждены явно передать дополнительные аргументы, чтобы сообщить Ansible параметры подключения.

> Ansible поддерживает программу `ssh-agent`, поэтому нет необходимости явно указывать файлы SSН-ключей в реестре.

> Ansible будет искать файл `ansible.cfg` в следующих местоположениях в указанном порядке: 
> 1. Файл, указанный в переменной окружения `ANSIBLE_CONFIG`. 
> 2. `./ansible.cfg` (`ansible.cfg` в текущем каталоге).
> 3. `~/Ansible.cfg` (`.Ansible.cfg` в вашем домашнем каталоге). 
> 4. `/etc/Ansible/Ansible.cfg`.

> `inventory` - файл реестра

> При работе с Vagrant удобео отключать проверкy SSН-ключей хоста.
>  ansible.cfg: 
> ```ini
> [defaults]
> inventoгy = hosts 
> геmоtе_usег = vagrant 
> private_key_file = .vagrant/мachines/default/virtualbox/prtvate_key 
> host_key_checktng = False
> ```

> С настройками по умолчанию отпадает необходимость указывать имя пользователя или файл с ключами SSH в файле `hosts`. Мы также можем запустить Ansible без аргумента `-i hostname`:
> ```shell
> $ ansible testserver -m ping
> ```

> Произвольные команды также можно выполнять с помощью модуля `command`. При запуске модуля необходимо указать аргумент `-а` с запускаемой командой:
> ```shell
> $ ansible testserver -m соmmаnd -а uptime
> ```

> Модуль `соmmаnd` настолько часто используется, что сделан модулем по умолчанию, то есть его имя можно опустить в команде:
> ```shell
> $ ansible testserver -а uptime
> ```

> Если команда в аргументе `-а` содержит пробелы, ее необходимо заключить в кавычки, чтобы командная оболочка передала всю строку как единый аргумент.

> Чтобы выполнить команду с привилегиями `root`, нужно передать параметр `-b`.


## Глава 2. Сценарии: начало
---

> Сценарием в Ansible называется файл, описывающий порядок управления конфигурациями.

> YAML: в примерах официальной документации Ansible обычно для передачи в аргументах модулей используются `yes` и `no` (что соответствует документации по модулям) и `True` и `False` во всех других случаях.

> В соответствии с соглашениями, принятыми в Ansible, файлы должны сохраняться в подкаталоге `files`, а шаблоны Jinja2 - в подкаталоге `templates`.

> Если вы не хотите видеть коров, можете отключить вызов `cowsay`, установив переменную окружения `ANSIBLE_NOCOWS`. Отключить `cowsay` можно также, добавив в файл `ansible.cfg`:
> ```ini
> [defaults] 
> nocows = 1
> ```

> Если файл сценария отмечен как выполняемый и начинается с такой строки: `#!/usr/bin/env ansible-playbook` в подобном случае вы сможете запустить его непосредственно: 
> ```shell
> $ ./web-notls.yмl
> ```

> Файлы YAML начинаются с трех дефисов `---`, обозначающих начало документа.

> Комментарии начинаются со знака «решетка» `#`.

> Обычно строки в YАМL не заключаются в кавычки, даже если они включают пробелы. Хотя это не возбраняется.
> 
> Иногда Ansible требует заключать строки в кавычки. Обычно это строки с фигурными скобками `{{` и `}}`, которые используются для подстановки значений переменных.

> Списки в YАМL похожи на массивы в JSON. Списки оформляются с помощью дефиса `-`.
> ```yaml
> - item1
> - item2
> ```
> 
> Формат встроенных списков: `[item1, item2]`.

> Словари в YAML подобны объектам в JSON. Технически в YAML они называются отображениями.
> ```yaml
> key1: value1
> key2: value2
> ```
> 
> Формат встроенных словарей: `{ key1: value1, key2: value2 }`.

> Объединение строк знаком "больше" `>`, чтобы Ansible воспринимал их как единую строку. Парсер YAML в этом случае заменит разрывы строк пробелами.

> Допустимый файл в формате JSON является также допустимым файлом в формате YAML.

> Каждая операция должна содержать: 
> - список настраиваемых хостов; 
> - список задач, выполняемых на этих хостах.
> 
> Воспринимайте операцию как нечто, связывающее хосты и задачи.

> `bесоmе`: Если имеет значение «истина», Ansible выполнит каждую задачу, предварительно приобретя привилегии пользователя `root` (по умолчанию).
> 
> Ubuntu по умолчанию не позволяет устанавливать SSН-соединение с привилегиями `root`.

> Задачи
> - Флаг `--start-at-task <имя задачи>`, чтобы с помощью `ansible-playbook` запустить сценарий с середины задачи
> - Каждая задача должна содержать ключ с названием модуля и его аргументами
> - Аргументы воспринимаются как строки, а не словари. То есть, чтобы разбить аргументы на несколько строк, необходимо использовать правило объединения строк YАМL
> - Ansible поддерживает также старый синтаксис, использующий ключ `action`

> Модули
> - Модули - это сценарии, которые поставляются с Ansible и производят определенное действие на хocте.
> - `file` устанавливает атрибуты файла, символической ссылки или каталога.
> - `seгvice` запускает, останавливает или перезапускает службу.
> - Ansible поставляется с утилитой командной строки `ansible-doc`, которая выводит документацию по модулям Ansible. Используйте ее как man-страницы для модулей.
> - В состав Ansible входит более 200 модулей, и их число растет с каждой новой версией.
> - Модули, поставляемые с Ansible, написаны на Python. Но, в принципе, они могут быть написаны на любом языке.

> Итак: сценарий содержит одну или несколько операций. Операции связываются с неупорядоченным множеством хостов и упорядоченным списком задач. Каждая задача соответствует только одному модулю.

> Любая запущенная задача потенциально может изменить состояние хоста. Перед тем как совершить какое-либо действие, модули проверяют, требуется ли изменить состояние хоста. Если состояние хоста соответствует значениям аргументов модуля, Ansible не предпринимает никаких действий и сообщает, что статус `ok`.
> 
> Если между состоянием хоста и значениями аргументов модуля есть разница, Ansible вносит изменения в состояние хоста и сообщает, что статус был изменен (`changed`).
> 
> Cпособность Ansible определять изменение состояния можно использовать для выполнения дополнительных действий с помощью обработчиков.

> Для промышленной эксплуатации сертификат TLS необходимо приобрести в центре сертификации или использовать бесплатную службу, такую как Let's Encrypt, которая поддерживается в Ansible посредством модуля `letsencгypt`.

> Переменные можно использовать в задачах и в файлах шаблонов. Для ссылки на переменные используются скобки `{{` и `}}`. Ansible заменит скобки значением переменной.

> Когда использовать кавычки
> - Если ссылка на переменную следует сразу после имени модуля, парсер YAML ошибочно воспримет ее как начало встроенного словаря. В данном случае необходимо заключить аргументы в кавычки: `соммаnd: "{{ mуарр }} -а foo"`
> - Похожая ошибка возникает при наличии двоеточия в аргументе. Двоеточие в аргументe сбивает синтаксический анализатор YAML. Чтобы избежать этого, необходимо заключить в кавычки все выражение аргумента. Необходимо заключить в кавычки не только аргумент целиком, но и сам аргумент. Ansible распознает одинарные и двойные кавычки: `debug: "msg='The debug module will print а message: neat, eh?'"`

> Шаблон - это простой текстовый файл, в котором с использованием специального синтаксиса определяются переменные, которые должны заменяться фактическими значениями.
> 
> Для поддержки шаблонов Ansible использует механизм Jinja2.
> 
> Мы используем расширение файла `.j2`, чтобы показать, что файл является шаблоном Jinja2. Однако вы можете использовать любое другое расширение.
> 
> Ansible также использует механизм шаблонов Jinja2 для определения пере  менных в сценариях.

> Ранние версии Ansible использовали знак доллара (`$`) вместо фигурных скобок для обозначения переменных в сценариях. Прежде, чтобы разыменовать переменную `foo`, на нее нужно было сослаться как `$foo`, в то время как сейчас используется форма `{{ foo }}`.

> Раздел обработчиков `handlers`
> - Обработчики - это одна из условных форм, поддерживаемых в Ansible. Обработчик схож с задачей, но запускается только после получения уведомления от задачи. Задача посылает уведомление, если обнаруживается изменение со  стояния системы после ее выполнения. 
> - Ключ `notify` в задачах. Задача уведомляет обработчик с именем, переданным ей в аргументе.
> - Обработчики выполняются только после завершения всех задач и только один раз, даже если было получено несколько. Они всегда выполняются в порядке следования в разделе `handlers`, а не в порядке поступления уведомлений.
> - Обработчики в основном используются для перезапуска служб и перезагрузки. Перезапуск службы всегда можно организовать в конце сценария и обойтись без использования уведомлений.
> - Неудобство обработчиков состоит в том, что они могут создавать сложности при отладке сценария.

> Браузеры, как Chrome, доверяют только сертификатам, выпущенным доверенным центром сертификации.
